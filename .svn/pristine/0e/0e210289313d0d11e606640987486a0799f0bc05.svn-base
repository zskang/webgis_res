dojo.require("esri.map");
dojo.require("esri.utils");
dojo.require("com.cabletech.map.CMap");
dojo.require("com.cabletech.map.CMenu");
dojo.require("dijit.layout.ContentPane");
dojo.require("com.cabletech.toolbar.ToolBar");
console.log('开始执行地图装载！');
var cmap, wgt,tb;
var identifyTask,identifyParams,featureSet;
dojo.ready(function() {
	var json = {
		geometryservice : "http://192.168.1.179:8399/arcgis/rest/services/Geometry/GeometryServer",
		proxyurl : contextPath+"/proxy.jsp",
		property : contextPath+"/res/popup.action",
		legendconfig : contextPath+"/legend.json",
		printurl: contextPath+"/res/index!export.action",
		baselayer : {
			label : "基础图层",
			url : "http://192.168.1.179:8399/arcgis/rest/services/shanxi_zq/MapServer"
		},
		operationlayer : {
			label : "资源图层",
			url : "http://192.168.1.179:8399/arcgis/rest/services/shanxi_res/MapServer",
			details : [
					{
						id : "1",
						url : "http://192.168.1.179:8399/arcgis/rest/services/shanxi_res/MapServer/1",
						type : "A23",
						label : "挂墙",
						where : ""
					},
					{
						id : "2",
						url : "http://192.168.1.179:8399/arcgis/rest/services/shanxi_res/MapServer/2",
						type : "A21",
						label : "管井",
						where : ""
					},
					{
						id : "3",
						url : "http://192.168.1.179:8399/arcgis/rest/services/shanxi_res/MapServer/3",
						type : "A20",
						label : "电杆",
						where : ""
					},
					{
						id : "6",
						url : "http://192.168.1.179:8399/arcgis/rest/services/shanxi_res/MapServer/6",
						type : "A32",
						label : "路由段",
						where : ""
					}
					]
		}
	};
	cmap = new com.cabletech.map.CMap("map", json);
	dojo.connect(cmap.map, "onMouseUp", dojo.hitch(this,function(evt){
        var outSR = new esri.SpatialReference({ wkid: 4326});
		cmap.geometryService.project([evt.mapPoint], outSR, function(projectedPoints) {
			var mp = projectedPoints[0];
			dojo.byId("info").innerHTML = "<span style='display:block;float:left;margin-top:6px;margin-left:10px;'>经度<span style='color:#7f001e;'>"+mp.x+"</span>&nbsp;&nbsp;&nbsp;&nbsp;纬度<span style='color:#7f001e;'>"+mp.y+"</span></span>";	
		});
	}));
	tb = new com.cabletech.toolbar.ToolBar(cmap);
	console.log('地图配置加载失败!');
	//加载菜单
	esri.request({
	    url:contextPath+"/res/index!getTopMenu.action",
	    handleAs: "json",
	    load: function(response, ioArgs){
			
			dojo.forEach(response, dojo.hitch(this,function(item, index){
	        	if(item.lv == 1){
	        		$(".ui-gis-head-right-menu").append("<div id='place"+index+"' style='float:left'></div>");
					var options = new com.cabletech.map.CMenuOptions(response,"place"+index,item.id);
					var menu = new com.cabletech.map.CMenu(options);
					menu.createMenu(item.text);
	        	}
	        }));
		},
	    error: function(response, ioArgs){
	    	alert("菜单加载失败!");
	    }
	});
});
/**
 * 添加点坐标
 */
var addPointLayer = null;
function addPoint(type){
	addPointLayer = cmap.createGraphicLayer("__addPointLayer");
	addPointLayer.clear();
	var drawToolbar = new esri.toolbars.Draw(cmap.map);
    var _drawEventHandle = dojo.connect(drawToolbar, "onDrawEnd", function(geometry){
        drawToolbar.deactivate();
		var syb = new esri.symbol.PictureMarkerSymbol("../legendIcons/"+type+".bmp", 16, 16);	
      	var graphic = new esri.Graphic(geometry, syb);
      	addPointLayer.add(graphic);
		dojo.disconnect(_drawEventHandle);
		var mp;
        var outSR = new esri.SpatialReference({ wkid: 4326});
		cmap.geometryService.project([geometry], outSR, function(projectedPoints) {
			mp = projectedPoints[0];
		    var lx = $("#pageFrame")[0].contentWindow.document.getElementById("pointX");
			var px = $("#pageFrame")[0].contentWindow.document.getElementById("projectx");
			lx.value = mp.x;
			px.value = geometry.x;
			var ly = $("#pageFrame")[0].contentWindow.document.getElementById("pointY");
			var py = $("#pageFrame")[0].contentWindow.document.getElementById("projecty");
			ly.value = mp.y;
			py.value = geometry.y;
        });

    });
	drawToolbar.activate(esri.toolbars.Draw.POINT);
}

	function refreshPoint(_type){
		addPointLayer.clear();
		var mapservice = cmap.map.getLayer(cmap.config.operationlayer.label)
		if(mapservice){
			mapservice.refresh();
		}
		var label = null;
		dojo.some(cmap.config.operationlayer.details, function(item){
			if(item.type === _type){
				label = item.label;
			}
        	return item.type === _type;
        });
        if(label){
			var layer = cmap.map.getLayer(label);
			layer.refresh();
        }
	}

/**
 * 搜索结果
 * @param graphic
 * @param type
 * @return
 */
function searchResults(graphic,type){
	identifyTask = new esri.tasks.IdentifyTask(cmap.config.operationlayer.url);

    identifyParams = new esri.tasks.IdentifyParameters();
    identifyParams.tolerance = 3;
    identifyParams.returnGeometry = true;
    identifyParams.layerIds = cmap.config.visibleLayers;
    identifyParams.layerOption = esri.tasks.IdentifyParameters.LAYER_OPTION_ALL;
    identifyParams.width  = cmap.map.width;
    identifyParams.height = cmap.map.height;
    identifyParams.geometry = graphic.geometry;
    identifyParams.mapExtent = cmap.map.extent;
    
    identifyTask.execute(identifyParams, function(idResults) {
    	exchangeDiv(contextPath+"/res/index!search.action","搜索结果");
    	featureSet = idResults;
    });
}

/**
 * 打开通用的Dialog对话框
 * @param _title 标题 
 * @param _url 需要载入的URL
 * @returns
 */
var openResourcetreediv =function(_title,_url,width,height,funRef){
    var w = 660;
    var fun=refeshTopWindow;
    if(width){
       w = width ;
    }
    var h = 500;
    if(height){
    	h = height;
    }
    if(funRef){
    	fun=funRef;
    }
	$.dialog({title:_title,content: 'url:'+_url,width:w,height:h,max:false,min:false,lock: true,close: fun});
}

/**
 * 打开通用的Dialog删除确认框
 * @param url 链接地址 
 * @param ids 串编号
 * @param win 当前操作窗口对象
 * @returns
*/
var openDeleteConfirmDiv = function(url, ids){
	$.dialog.confirm("确认删除吗？",function(){
		$.ajax({
			url:url,dataType:'html',data:"xtbhs="+ids,
			success:function(text){
				if(text == '删除成功！'){
					noty({layout:'topCenter',theme:'noty_theme_mitgux',type: 'success',text:text,timeout:1500});
					refeshTopWindow();
				}else{
					noty({layout:'topCenter',theme:'noty_theme_mitgux',type: 'error',text:text,timeout:1500});
				}
			}
		});
	});
};
/**
 * 弹出消息框
 * 
 * @param content
 * @param flag
 * @returns
 */
var opentipmessage = function(content,flag){
	var successicon = "success.gif";
	var erroricon = "error.gif";
	var icons = successicon;
	if(flag == "error"){
		icons = erroricon;
	}
	$.dialog({
	    id: 'msg',
	    content: content,
	    icon:icons,
	    width: 200,
	    height: 100,
	    left: '100%',
	    top: '100%',
	    fixed: true,
	    drag: false,
	    resize: false,
	    init: function () {
	        var that = this, i = 3;
	        var fn = function () {
	            that.title(i + '秒后关闭');
	            !i && that.close();
	            i --;
	        };
	        timer = setInterval(fn, 1000);
	        fn();
	    },
	    close: function () {
	        clearInterval(timer);
	    }
	});
}
/**
 * 加载右边部分的内容
 * 
 * @returns
 */
var loadRightFrame = function(url) {
	// mainlayout.sizePane("east", 500);
	$("#rightframe").load(url);
}
/**
 * 使用动态切换效果，完成页面编辑操作
 * @param url 需要载入的URL
 * @param _title 标题
 * @param _width 宽度
 * @returns
 */
var exchangeDiv = function(url,_title, _width) {
	var _w = 420;
	if(_width){
		_w = _width;
	}	
	mainlayout.sizePane("east", _w);
	$("#rightframe").css("display", "none");
	$("#exchangediv").css("display", "");
	$("#exchangediv").show("slide", {}, 500, function() {
		document.getElementById("pageFrame").src = url;
		$("#divtipname").html("-" + _title);
	});
	
}
/**
 * 返回到菜单主页面
 * 
 * @returns
 */
var exchangeBackDiv = function() {
	if($("#rightframe").css("display")=="none"){
		document.getElementById("pageFrame").src = "";
		$("#exchangediv").hide("slide", {}, 500, function() {
			$("#rightframe").css("display", "");
			$("#exchangediv").css("display", "none");
			mainlayout.sizePane("east", 320);
		});
	}
}

/**
 * 当前在线人员信息
 * 
 * @returns
 */
$('.onlineuserinfo').qtip({
	content : {
		text : 'Loading...', // The text to use whilst the AJAX request is
								// loading
		ajax : {
			url : 'index!onlineuerinfo.action', // URL to the local file
			type : 'GET'
		},
		title : {
			text : '登陆用户信息',
			button : true
		}
	},
	hide : 'unfocus',
	position : {
		at : 'bottom center ', // Position the tooltip above the link
		my : 'top right'
	},
	show : {
		event : 'click',
		solo : true
	// Only show one tooltip at a time
	},
	style : {
		classes : 'ui-tooltip-shadow ui-tooltip-blue'
	}
});

/**
 * 刷新数据窗口
 */
var refeshTopWindow=function(){
	var iframe = document.getElementById('pageFrame');
	iframe.contentWindow.location.replace(iframe.src+$('#pagecon').val());
}

/**
* 定位
* @param restype 资源类型
* @param objectIds 资源编号集合 24769,24770,24780
*/
var locate=function(restype, objectIds){
	cmap.locateObject(restype, objectIds);
}

/**
 * Esri Ajax Rest 方式提交点、线和面数据到FeatureLayer中
 * @param options {'url':url,'features':features} 参数内容
 * @returns
 */
var esriAjaxRestPost = function(options){
	if(!options.url){
		$.fn.Alert("请传入URL参数!",4);
		return false;
	}else if(!options.features){
		$.fn.Alert("请传入features参数!",4);
		return false;
	}
	var param = {"f":"pjson","features":options.features};
	$.ajax({
		url:options.url,
		type:'POST',
		data:param,
		dataType:'jsonp',
		success:function(data){
			console.log("资源添加成功！"+data);
		},
		error:function(data){
			console.log("资源添加失败！");
		}
	});
 
//	esri.request({
//	    url: options.url,
//	    content: {
//	    	"f":"pjson",
//	    	"features":options.features
//	    },
//	    handleAs: "text",
//	    callbackParamName: "jsoncallback",
//	    load: function(data){
//	    	console.log("load sucess!");
//	    },
//	    error: function(data){
//	    	console.log("load error!"+data);
//	    }
//	  },{usePost:true});
	}
 